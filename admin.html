<!DOCTYPE html>
<html lang="tr">

<head>
    <title>AR Admin - Profesyonel Y√∂netim</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- AR & Map K√ºt√ºphaneleri -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --p: #007bff;
            --glass: rgba(15, 15, 15, 0.95);
        }

        body {
            margin: 0;
            background: #000;
            color: #fff;
            font-family: -apple-system, sans-serif;
            overflow: hidden;
        }

        /* --- YAN MENU (SIDEBAR) --- */
        #admin-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 340px;
            height: 100%;
            background: var(--glass);
            z-index: 2000;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            border-right: 1px solid #333;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-100%);
            /* Ba≈ülangƒ±√ßta gizli */
        }

        #admin-sidebar.open {
            transform: translateX(0);
        }

        /* --- MENU BUTONU --- */
        #menu-toggle {
            position: fixed;
            left: 20px;
            top: 20px;
            z-index: 2001;
            background: var(--p);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        /* --- √úST DURUM √áUBUƒûU --- */
        #status-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 20px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 13px;
            pointer-events: none;
        }

        #map {
            height: 180px;
            border-radius: 12px;
            margin: 10px 0;
            border: 1px solid #444;
        }

        .control-group {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #333;
        }

        label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
            font-weight: bold;
            text-transform: uppercase;
        }

        input {
            background: #222;
            border: 1px solid #333;
            color: #fff;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn {
            background: var(--p);
            color: #fff;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: 0.2s;
        }

        .btn:active {
            transform: scale(0.96);
        }

        .btn-loc {
            background: #6f42c1;
            margin-bottom: 10px;
        }

        .btn-save {
            background: #28a745;
            margin-top: 15px;
        }

        .project-card {
            background: #222;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 1px solid #333;
            font-size: 14px;
        }

        .project-card.active {
            border-color: var(--p);
            background: #2a2a2a;
        }

        video {
            width: 100vw !important;
            height: 100vh !important;
            object-fit: cover !important;
            position: absolute;
        }
    </style>
</head>

<body>

    <!-- Men√º A√ßma/Kapama -->
    <button id="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>

    <!-- √úst Durum Bilgisi (Her zaman g√∂r√ºn√ºyor) -->
    <div id="status-bar">
        <span id="active-proj-name">Proje Se√ßilmedi</span> |
        üìè Mesafe: <span id="live-dist">0</span>m |
        üìç GPS: <span id="live-gps">Aranƒ±yor...</span>
    </div>

    <!-- Admin Yan Men√ºs√º -->
    <div id="admin-sidebar">
        <h2 style="margin:0; display:flex; align-items:center; gap:10px;">üèóÔ∏è AR STUDIO</h2>

        <div id="list-view">
            <label>PROJELERƒ∞M</label>
            <div id="project-list"></div>
            <button class="btn" style="background:#333" onclick="createNewProject()">+ Yeni Proje Olu≈ütur</button>
        </div>

        <div id="edit-view" style="display:none; margin-top:10px;">
            <div class="control-group">
                <label>TEMEL Bƒ∞LGƒ∞LER</label>
                <input type="text" id="p-name" placeholder="Proje Adƒ±">
                <input type="text" id="p-model" placeholder="model.glb">

                <label>KONUM AYARI</label>
                <button class="btn btn-loc" onclick="useCurrentLocation()">üìç ≈ûUANKƒ∞ KONUMUMU KULLAN</button>
                <div id="map"></div>
                <div id="p-coords" style="font-size:10px; color:#28a745; text-align:center;">Haritadan se√ßebilir veya
                    butona basabilirsiniz.</div>
            </div>

            <div class="control-group">
                <label>CANLI AR AYARLARI</label>
                <label>B√ºy√ºkl√ºk (Scale): <span id="v-scale">10</span></label>
                <input type="range" id="p-scale" min="1" max="100" value="10">

                <label>D√∂n√º≈ü (Rotation): <span id="v-rot">0</span>¬∞</label>
                <input type="range" id="p-rot" min="0" max="360" value="0">

                <label>Zemin Y√ºksekliƒüi: <span id="v-alt">0</span></label>
                <input type="range" id="p-alt" min="-10" max="20" value="0" step="0.1">
            </div>

            <button class="btn btn-save" onclick="saveData()">DEƒûƒ∞≈ûƒ∞KLƒ∞KLERƒ∞ KAYDET</button>
            <button class="btn" style="background:#dc3545; margin-top:10px; padding:10px; font-size:12px;"
                onclick="deleteProject()">Projeyi Sil</button>

            <div style="background:#000; padding:15px; border-radius:12px; margin-top:15px; border:1px solid #222;">
                <label>PAYLA≈ûILABƒ∞Lƒ∞R Lƒ∞NK</label>
                <div id="p-link" style="font-size:10px; color:var(--p); word-break:break-all; margin:10px 0;"></div>
                <button class="btn" style="padding:8px; font-size:11px;" onclick="copyLink()">Linki Kopyala</button>
            </div>
        </div>
    </div>

    <!-- AR Sahnesi -->
    <a-scene embedded vr-mode-ui="enabled: false" arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;">
        <a-entity light="type: hemisphere; intensity: 2"></a-entity>
        <a-entity light="type: directional; intensity: 1.5;" position="1 2 1"></a-entity>

        <a-entity id="ar-obj" gltf-model="" gps-entity-place="latitude: 0; longitude: 0;"></a-entity>

        <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
        // --- VERƒ∞TABANI & DURUM ---
        let db = JSON.parse(localStorage.getItem('ar_db')) || {};
        let activeId = null;
        let userPos = { lat: 0, lon: 0 };

        // --- HARƒ∞TA BA≈ûLATMA ---
        const map = L.map('map').setView([41.017039, 28.858800], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let marker = L.marker([41.017039, 28.858800]).addTo(map);

        map.on('click', (e) => {
            if (!activeId) return;
            db[activeId].lat = e.latlng.lat;
            db[activeId].lon = e.latlng.lng;
            marker.setLatLng(e.latlng);
            updateARView();
        });

        // --- GPS TAKƒ∞Bƒ∞ ---
        window.addEventListener('gps-camera-update-position', (e) => {
            userPos.lat = e.detail.position.latitude;
            userPos.lon = e.detail.position.longitude;
            document.getElementById('live-gps').innerText = `${userPos.lat.toFixed(5)}, ${userPos.lon.toFixed(5)}`;

            if (activeId) {
                const dist = document.getElementById('ar-obj').getAttribute('distance');
                if (dist !== null) document.getElementById('live-dist').innerText = Math.round(dist);
            }
        });

        // --- CANLI AR EKRANINA DOKUNARAK YERLE≈ûTƒ∞RME ---
        document.querySelector('a-scene').addEventListener('click', () => {
            if (!activeId || userPos.lat === 0) return;

            // Kameranƒ±n baktƒ±ƒüƒ± a√ßƒ±yƒ± al
            const camera = document.querySelector('[gps-camera]');
            const rotation = camera.getAttribute('rotation');

            // Kameranƒ±n baktƒ±ƒüƒ± y√∂ne doƒüru 10 metre ileriye yerle≈ütir
            const distance = 10;
            const angle = (rotation.y) * Math.PI / 180;

            const dNorth = Math.cos(angle) * distance;
            const dEast = -Math.sin(angle) * distance;

            const R = 6371000; // D√ºnya yarƒ±√ßapƒ±
            const newLat = userPos.lat + (dNorth / R) * (180 / Math.PI);
            const newLon = userPos.lon + (dEast / (R * Math.max(Math.cos(userPos.lat * Math.PI / 180), 0.001))) * (180 / Math.PI);

            db[activeId].lat = newLat;
            db[activeId].lon = newLon;

            marker.setLatLng([newLat, newLon]);
            map.panTo([newLat, newLon]);

            updateARView();
            console.log("Model yeni noktaya ta≈üƒ±ndƒ±!");
        });

        function useCurrentLocation() {
            if (userPos.lat === 0) { alert("Sinyal bekleniyor..."); return; }
            db[activeId].lat = userPos.lat;
            db[activeId].lon = userPos.lon;
            marker.setLatLng([userPos.lat, userPos.lon]);
            map.panTo([userPos.lat, userPos.lon]);
            updateARView();
        }

        // --- MENU KONTROL√ú ---
        function toggleSidebar() {
            const sidebar = document.getElementById('admin-sidebar');
            sidebar.classList.toggle('open');
            const btn = document.getElementById('menu-toggle');
            btn.innerText = sidebar.classList.contains('open') ? '‚úï' : '‚ò∞';
            if (sidebar.classList.contains('open')) setTimeout(() => map.invalidateSize(), 400);
        }

        // --- PROJE Y√ñNETƒ∞Mƒ∞ ---
        function renderList() {
            const list = document.getElementById('project-list');
            list.innerHTML = '';
            for (let id in db) {
                const card = document.createElement('div');
                card.className = `project-card ${activeId === id ? 'active' : ''}`;
                card.innerText = db[id].name;
                card.onclick = () => loadProject(id);
                list.appendChild(card);
            }
        }

        function createNewProject() {
            const name = prompt("Proje Adƒ±:");
            if (!name) return;
            const id = 'p_' + Date.now();
            db[id] = { id: id, name: name, model: 'model.glb', lat: 41.017039, lon: 28.858800, scale: 10, rot: 0, alt: 0 };
            saveDB();
            loadProject(id);
        }

        function loadProject(id) {
            activeId = id;
            const p = db[id];
            document.getElementById('edit-view').style.display = 'block';
            document.getElementById('active-proj-name').innerText = p.name;

            document.getElementById('p-name').value = p.name;
            document.getElementById('p-model').value = p.model;
            document.getElementById('p-scale').value = p.scale;
            document.getElementById('v-scale').innerText = p.scale;
            document.getElementById('p-rot').value = p.rot;
            document.getElementById('v-rot').innerText = p.rot;
            document.getElementById('p-alt').value = p.alt;
            document.getElementById('v-alt').innerText = p.alt;

            marker.setLatLng([p.lat, p.lon]);
            map.panTo([p.lat, p.lon]);

            const link = window.location.href.replace('admin.html', 'index.html') + '?id=' + id;
            document.getElementById('p-link').innerText = link;

            renderList();
            updateARView();
        }

        function updateARView() {
            const p = db[activeId];
            if (!p) return;
            const el = document.getElementById('ar-obj');
            el.setAttribute('gltf-model', `url(${p.model})`);
            el.setAttribute('gps-entity-place', `latitude: ${p.lat}; longitude: ${p.lon};`);
            el.setAttribute('scale', `${p.scale} ${p.scale} ${p.scale}`);
            el.setAttribute('rotation', `0 ${p.rot} 0`);
            el.setAttribute('position', `0 ${p.alt} 0`);
        }

        // --- AYAR Dƒ∞NLEYƒ∞Cƒ∞LERƒ∞ ---
        ['p-scale', 'p-rot', 'p-alt'].forEach(key => {
            document.getElementById(key).oninput = (e) => {
                const val = parseFloat(e.target.value);
                const field = key.replace('p-', '');
                db[activeId][field] = val;
                document.getElementById('v-' + field).innerText = val;
                updateARView();
            };
        });

        function saveData() {
            db[activeId].name = document.getElementById('p-name').value;
            db[activeId].model = document.getElementById('p-model').value;
            saveDB();
            alert("Proje ayarlarƒ± kaydedildi!");
            renderList();
        }

        function deleteProject() {
            if (!confirm("Bu projeyi silmek istediƒüinize emin misiniz?")) return;
            delete db[activeId];
            saveDB();
            activeId = null;
            document.getElementById('edit-view').style.display = 'none';
            document.getElementById('active-proj-name').innerText = "Proje Se√ßilmedi";
            renderList();
        }

        function saveDB() { localStorage.setItem('ar_db', JSON.stringify(db)); }
        function copyLink() { navigator.clipboard.writeText(document.getElementById('p-link').innerText); alert("Link Kopyalandƒ±!"); }

        renderList();

        // Video tam ekran fix
        setInterval(() => {
            const v = document.querySelector('video');
            if (v) v.style.objectFit = "cover";
        }, 1000);
    </script>
</body>

</html>

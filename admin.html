<!DOCTYPE html>
<html lang="tr">
<head>
    <title>AR Studio - Native LiDAR</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <!-- Harita i√ßin -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --p: #007bff; --glass: rgba(10, 10, 10, 0.9); }
        body, html { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#000; font-family:sans-serif; }
        
        /* UI Katmanlarƒ± */
        #ui-layer { position: absolute; top:0; left:0; width:100%; height:100%; z-index:100; pointer-events:none; }
        #ui-layer * { pointer-events: auto; }

        #admin-panel { position:fixed; left:0; top:0; width:280px; height:100%; background:var(--glass); backdrop-filter:blur(20px); padding:20px; transform:translateX(-100%); transition:0.4s; overflow-y:auto; box-sizing:border-box; color:white; border-right:1px solid #333; }
        #admin-panel.open { transform:translateX(0); }

        #menu-btn { position:fixed; left:15px; top:15px; background:var(--p); color:white; border:none; width:50px; height:50px; border-radius:12px; font-size:24px; cursor:pointer; }
        
        #overlay-msg { position:fixed; top:80px; width:100%; text-align:center; color:#00f2ff; font-weight:bold; text-shadow:0 0 10px #000; font-size:14px; }
        
        .ar-btn { position:fixed; bottom:40px; left:50%; transform:translateX(-50%); padding:18px 45px; border-radius:50px; background:#00f2ff; color:#000; border:none; font-weight:bold; font-size:16px; box-shadow:0 0 20px rgba(0,242,255,0.4); display:none; }

        .card { background:rgba(255,255,255,0.05); padding:10px; border-radius:12px; margin-bottom:10px; }
        #map { height:150px; border-radius:10px; margin-bottom:10px; }
        input, select { background:#222; color:#fff; border:1px solid #444; width:100%; padding:10px; border-radius:8px; margin-bottom:10px; box-sizing:border-box; }
        
        #splash { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; text-align:center; }
    </style>
</head>
<body>

    <div id="splash">
        <h1>NATIVE AR PRO</h1>
        <p style="color:#666; margin-bottom:30px;">Zemin Tarama Teknolojisi</p>
        <button onclick="startAR()" style="padding:20px 50px; border-radius:50px; border:none; background:#fff; font-weight:bold; cursor:pointer;">AR'I BA≈ûLAT</button>
    </div>

    <div id="ui-layer">
        <button id="menu-btn" onclick="toggleMenu()">‚ò∞</button>
        <div id="overlay-msg">Zemini tarayƒ±n ve noktayƒ± se√ßin</div>
        <button id="place-btn" class="ar-btn" onclick="confirmPlacement()">üèóÔ∏è BURAYA YERLE≈ûTƒ∞R</button>

        <div id="admin-panel">
            <h3>Proje Y√∂netimi</h3>
            <select id="proj-select" onchange="selectProj(this.value)"></select>
            <button onclick="addNew()" style="width:100%; padding:10px; outline:none; border:none; background:#333; color:#fff; border-radius:8px; margin-bottom:15px;">+ YENƒ∞ EKLE</button>
            
            <div id="editor" style="display:none">
                <input type="text" id="p-name" placeholder="Proje Adƒ±">
                <div id="map"></div>
                <div class="card">
                    <label style="font-size:10px; color:#888;">√ñL√áEK: <span id="v-s">10</span></label>
                    <input type="range" id="p-scale" min="1" max="100" value="10" style="width:100%">
                    <label style="font-size:10px; color:#888; margin-top:5px; display:block">Y√úKSEKLƒ∞K: <span id="v-a">0</span></label>
                    <input type="range" id="p-alt" min="-10" max="25" value="0" step="0.1" style="width:100%">
                </div>
                <button onclick="save()" style="width:100%; padding:15px; background:#28a745; color:#fff; border:none; border-radius:10px; font-weight:bold;">KAYDET</button>
                <div id="p-link" style="font-size:8px; color:#007bff; margin-top:10px; word-break:break-all;"></div>
            </div>
        </div>
    </div>

    <!-- WebXR Sahnesi (Video Yok, Sahne ≈ûeffaf) -->
    <a-scene 
        webxr="requiredFeatures: hit-test, local-floor; optionalFeatures: dom-overlay; overlayElement: #ui-layer;"
        vr-mode-ui="enabled: false"
        renderer="antialias: true; alpha: true;">
        
        <a-assets id="assets"></a-assets>

        <!-- Zemin Tespit Halkasƒ± (Reticle) -->
        <a-entity id="reticle" visible="false">
            <a-ring color="#00f2ff" radius-inner="0.08" radius-outer="0.1" rotation="-90 0 0"></a-ring>
            <a-circle color="#00f2ff" radius="0.01" rotation="-90 0 0" opacity="0.5"></a-circle>
        </a-entity>

        <!-- Yerle≈üecek Model -->
        <a-entity id="ar-obj" visible="false"></a-entity>

        <a-entity light="type: hemisphere; intensity: 1.5"></a-entity>
        <a-entity light="type: directional; intensity: 0.8" position="1 2 1"></a-entity>
    </a-scene>

    <script>
        let db = JSON.parse(localStorage.getItem('ar_db')) || {};
        let activeId = null;
        let myPos = { lat: 0, lon: 0 };
        let currentHitPoint = null;

        const map = L.map('map').setView([41.017, 28.858], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let marker = L.marker([41.017, 28.858]).addTo(map);

        async function startAR() {
            document.getElementById('splash').style.display = 'none';
            const scene = document.querySelector('a-scene');
            scene.enterVR(); // WebXR AR moduna girer
        }

        // GPS Takibi
        navigator.geolocation.watchPosition(p => {
            myPos.lat = p.coords.latitude; myPos.lon = p.coords.longitude;
            if(!activeId) { map.setView([myPos.lat, myPos.lon], 17); marker.setLatLng([myPos.lat, myPos.lon]); }
        }, err => console.error(err), { enableHighAccuracy: true });

        // WebXR Hit-Test (Zemin Tespiti) D√∂ng√ºs√º
        const reticle = document.getElementById('reticle');
        const planeBtn = document.getElementById('place-btn');
        const msg = document.getElementById('overlay-msg');

        document.querySelector('a-scene').addEventListener('enter-vr', () => {
            const session = document.querySelector('a-scene').xrSession;
            session.requestReferenceSpace('viewer').then(refSpace => {
                session.requestHitTestSource({ space: refSpace }).then(source => {
                    window.hitTestSource = source;
                });
            });
        });

        document.querySelector('a-scene').addEventListener('renderstart', () => {
            const frame = document.querySelector('a-scene').frame;
            const session = document.querySelector('a-scene').xrSession;
            if (!session || !window.hitTestSource) return;

            const hitTestResults = frame.getHitTestResults(window.hitTestSource);
            if (hitTestResults.length > 0) {
                const hit = hitTestResults[0];
                const referenceSpace = document.querySelector('a-scene').renderer.xr.getReferenceSpace();
                const pose = hit.getPose(referenceSpace);

                reticle.setAttribute('visible', 'true');
                reticle.setAttribute('position', pose.transform.position);
                currentHitPoint = pose.transform.position;
                
                if(activeId) planeBtn.style.display = 'block';
                msg.innerText = "Zemin Tespit Edildi!";
            } else {
                reticle.setAttribute('visible', 'false');
                planeBtn.style.display = 'none';
                msg.innerText = "Zemini Taramaya Devam Edin...";
            }
        });

        function confirmPlacement() {
            if(!activeId || !currentHitPoint) return;
            
            // WebXR koordinatlarƒ±nƒ± (metre) GPS'e √ßevirme sim√ºlasyonu
            // (Karma≈üƒ±k math: Mevcut GPS + Kamera A√ßƒ±sƒ± + Mesafe)
            const scene = document.querySelector('a-scene');
            const cam = scene.camera.el.getAttribute('rotation');
            const dist = Math.sqrt(currentHitPoint.x**2 + currentHitPoint.z**2);
            const angle = (cam.y) * Math.PI / 180;
            
            const dN = Math.cos(angle) * dist;
            const dE = -Math.sin(angle) * dist;
            const R = 6371000;
            
            db[activeId].lat = myPos.lat + (dN / R) * (180 / Math.PI);
            db[activeId].lon = myPos.lon + (dE / (R * Math.cos(myPos.lat * Math.PI / 180))) * (180 / Math.PI);
            
            save();
            marker.setLatLng([db[activeId].lat, db[activeId].lon]);
            map.panTo([db[activeId].lat, db[activeId].lon]);
            
            const obj = document.getElementById('ar-obj');
            obj.setAttribute('visible', 'true');
            obj.setAttribute('position', currentHitPoint);
            obj.setAttribute('gltf-model', db[activeId].model);
            obj.setAttribute('scale', `${db[activeId].scale/10} ${db[activeId].scale/10} ${db[activeId].scale/10}`);
            
            alert("ƒ∞n≈üaat Ba≈üarƒ±yla GPS'e √áivilendi!");
        }

        function toggleMenu() { document.getElementById('admin-panel').classList.toggle('open'); setTimeout(()=>map.invalidateSize(),400); }
        function selectProj(id) { if(!id) return; activeId = id; document.getElementById('editor').style.display='block'; loadEditor(); }
        function loadEditor() {
            const p = db[activeId];
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-scale').value = p.scale;
            marker.setLatLng([p.lat, p.lon]); map.panTo([p.lat, p.lon]);
            document.getElementById('p-link').innerText = window.location.href.split('admin.html')[0] + 'index.html?id=' + activeId;
        }
        function save() { localStorage.setItem('ar_db', JSON.stringify(db)); }
        function addNew() { const n = prompt("Ad:"); if(!n) return; const id = 'p' + Date.now(); db[id] = {id:id, name:n, model:'model.glb', lat:41.017, lon:28.858, scale:10, rot:0, alt:0}; save(); location.reload(); }
        
        refreshList();
        function refreshList() { 
            const c = document.getElementById('proj-select'); c.innerHTML = '<option value="">-- Proje Se√ß --</option>';
            for(let id in db) { const o = document.createElement('option'); o.value = id; o.innerText = db[id].name; c.appendChild(o); } 
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
    <title>AR Admin Studio - Black Screen Fix</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- Stabil A-Frame & AR.js -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --p: #007bff; --glass: rgba(15, 15, 15, 0.85); }
        body, html { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:transparent!important; font-family:-apple-system, sans-serif; }
        
        /* Ã–NEMLÄ°: Siyah ekranÄ± Ã¶nlemek iÃ§in video katmanÄ±nÄ± zorla Ã¼ste Ã§Ä±karÄ±yoruz */
        video#arjs-video {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            object-fit: cover !important;
            z-index: -2 !important; /* A-Frame canvasÄ±nÄ±n arkasÄ±nda */
            display: block !important;
        }

        .a-canvas {
            z-index: -1 !important;
            background: transparent !important;
        }

        /* --- ADMIN UI --- */
        #admin-panel { position:fixed; left:0; top:0; width:280px; height:100%; background:var(--glass); backdrop-filter:blur(20px); z-index:2000; padding:20px; display:flex; flex-direction:column; gap:12px; overflow-y:auto; border-right:1px solid rgba(255,255,255,0.1); transition:transform .4s ease; transform:translateX(-100%); box-sizing:border-box; color: white; }
        #admin-panel.open { transform:translateX(0); }
        #menu-btn { position:fixed; left:15px; top:15px; z-index:2001; background:var(--p); color:white; border:none; width:45px; height:45px; border-radius:12px; cursor:pointer; font-size:20px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        #status-bar { position:fixed; top:15px; right:15px; z-index:1000; background:rgba(0,0,0,0.5); padding:8px 15px; border-radius:30px; font-size:11px; color:#fff; border:1px solid rgba(255,255,255,0.1); pointer-events:none; }
        #drag-controls { position:fixed; bottom:20px; right:20px; z-index:1500; display:grid; grid-template-columns:repeat(3, 45px); gap:8px; }
        .drag-btn { width:45px; height:45px; background:rgba(255,255,255,0.2); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.2); border-radius:10px; color:white; font-size:18px; display:flex; align-items:center; justify-content:center; }
        .card { background:rgba(255,255,255,0.05); padding:12px; border-radius:12px; }
        label { display:block; font-size:9px; color:#888; font-weight:bold; text-transform:uppercase; margin-bottom:4px; }
        input, select { background:rgba(0,0,0,0.4); border:1px solid #333; color:#fff; padding:8px; border-radius:6px; width:100%; box-sizing:border-box; font-size:12px; margin-bottom:8px; }
        .btn { background:var(--p); color:#fff; border:none; padding:12px; border-radius:10px; font-weight:bold; cursor:pointer; width:100%; transition:.2s; }
        #map { height:130px; border-radius:10px; margin:8px 0; border: 1px solid #444; }
        #splash { position:fixed; top:0; left:0; width:100%; height:100%; background:#000; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; color: white; }
    </style>
</head>
<body>

    <div id="splash">
        <h2 style="margin-bottom:10px;">AR STUDIO ADMIN</h2>
        <p style="color:#888; margin-bottom:20px;">KamerayÄ± ve SensÃ¶rleri BaÅŸlat</p>
        <button class="btn" style="width:250px; padding:20px" onclick="startSystem()">BAÅLAT</button>
    </div>

    <button id="menu-btn" onclick="toggleMenu()">â˜°</button>

    <div id="status-bar">
        ğŸ“ <span id="dist">0</span>m | ğŸ“ <span id="gps">Bekleniyor...</span>
    </div>

    <!-- Ok TuÅŸlarÄ± -->
    <div id="drag-controls" style="display:none">
        <div></div><button class="drag-btn" onclick="move('N')">â†‘</button><div></div>
        <button class="drag-btn" onclick="move('W')">â†</button>
        <button class="drag-btn" onclick="save()" style="font-size:10px; background:#28a745">KAYDET</button>
        <button class="drag-btn" onclick="move('E')">â†’</button>
        <div></div><button class="drag-btn" onclick="move('S')">â†“</button><div></div>
    </div>

    <div id="admin-panel">
        <h3 style="margin:0 0 10px 0">AR Studio</h3>
        <label>PROJE LÄ°STESÄ°</label>
        <select id="proj-select" onchange="loadProj(this.value)"><option value="">-- SeÃ§iniz --</option></select>
        <button class="btn" style="background:#333; margin-bottom:10px; font-size:11px" onclick="addNew()">+ YENÄ° PROJE</button>

        <div id="editor" style="display:none">
            <div class="card">
                <input type="text" id="p-name" placeholder="Proje AdÄ±">
                <input type="text" id="p-model" placeholder="model.glb">
                <div id="map"></div>
                <button class="btn" style="background:#6f42c1; font-size:10px; padding:8px" onclick="setAtMe()">ğŸ“ KONUMUMA GETÄ°R</button>
            </div>
            <div class="card" style="margin-top:10px">
                <label>Ã–lÃ§ek: <span id="v-s">10</span></label>
                <input type="range" id="p-scale" min="1" max="100" value="10">
                <label>DÃ¶nÃ¼ÅŸ: <span id="v-r">0</span>Â°</label>
                <input type="range" id="p-rot" min="0" max="360" value="0">
                <label>YÃ¼kseklik: <span id="v-a">0</span></label>
                <input type="range" id="p-alt" min="-10" max="20" value="0" step="0.1">
            </div>
            <button class="btn" style="background:#28a745; margin-top:10px;" onclick="save()">BÄ°LGÄ°LERÄ° KAYDET</button>
            <button class="btn" style="background:#dc3545; font-size:11px; margin-top:5px" onclick="delProj()">SÄ°L</button>
            
            <div class="card" style="margin-top:15px; background:#000">
                <label>PAYLAÅIM LÄ°NKÄ°</label>
                <div id="p-link" style="font-size:8px; color:#007bff; word-break:break-all; margin:8px 0"></div>
                <button class="btn" style="padding:6px; font-size:10px; background:#444" onclick="copyLink()">Linki Kopyala</button>
            </div>
        </div>
    </div>

    <!-- AR Sahnesi - Åeffaf Arka Plan Modu -->
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
        renderer="alpha: true; colorManagement: true;">
        
        <a-entity light="type: hemisphere; intensity: 2"></a-entity>
        <a-entity light="type: directional; intensity: 1.5;" position="1 2 1"></a-entity>
        <a-entity id="ar-obj" gltf-model=""></a-entity>
        <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
        let db = JSON.parse(localStorage.getItem('ar_db')) || {};
        let activeId = null; let myPos = { lat: 0, lon: 0 };
        
        const map = L.map('map').setView([41.017, 28.858], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let marker = L.marker([41.017, 28.858]).addTo(map);

        map.on('click', (e) => { if(!activeId) return; db[activeId].lat = e.latlng.lat; db[activeId].lon = e.latlng.lng; marker.setLatLng(e.latlng); sync(); });

        // Ekrana Dokunarak YerleÅŸtirme
        document.querySelector('a-scene').addEventListener('click', (e) => {
            if (!activeId || myPos.lat === 0 || e.target.closest('#admin-panel') || e.target.closest('#menu-btn')) return;
            const cam = document.querySelector('[gps-camera]'); const rot = cam.getAttribute('rotation');
            const dist = 10; const angle = (rot.y) * Math.PI / 180;
            const dN = Math.cos(angle) * dist; const dE = -Math.sin(angle) * dist; const R = 6371000;
            const nLat = myPos.lat + (dN / R) * (180 / Math.PI);
            const nLon = myPos.lon + (dE / (R * Math.cos(myPos.lat * Math.PI / 180))) * (180 / Math.PI);
            db[activeId].lat = nLat; db[activeId].lon = nLon; marker.setLatLng([nLat, nLon]); sync();
        });

        function startSystem() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(res => { finish(); }).catch(finish);
            } else finish();
        }

        function finish() { document.getElementById('splash').style.display = 'none'; }

        window.addEventListener('gps-camera-update-position', (e) => {
            myPos.lat = e.detail.position.latitude; myPos.lon = e.detail.position.longitude;
            document.getElementById('gps').innerText = `${myPos.lat.toFixed(4)}, ${myPos.lon.toFixed(4)}`;
            if(activeId) { 
                const d = document.getElementById('ar-obj').getAttribute('distance'); 
                if(d!==null) document.getElementById('dist').innerText = Math.round(d); 
            }
        });

        function toggleMenu() { const p = document.getElementById('admin-panel'); p.classList.toggle('open'); document.getElementById('menu-btn').innerText = p.classList.contains('open') ? 'âœ•':'â˜°'; if(p.classList.contains('open')) setTimeout(()=>map.invalidateSize(), 300); }
        function refreshList() { const c = document.getElementById('proj-select'); c.innerHTML = '<option value="">-- SeÃ§iniz --</option>'; for(let id in db) { const o = document.createElement('option'); o.value = id; o.innerText = db[id].name; o.selected = (id===activeId); c.appendChild(o); } }
        
        function loadProj(id) {
            if(!id) { document.getElementById('editor').style.display='none'; document.getElementById('drag-controls').style.display='none'; return; }
            activeId = id; document.getElementById('editor').style.display='block'; document.getElementById('drag-controls').style.display='grid';
            const p = db[id]; document.getElementById('p-name').value = p.name; document.getElementById('p-model').value = p.model;
            document.getElementById('p-scale').value = p.scale; document.getElementById('p-rot').value = p.rot; document.getElementById('p-alt').value = p.alt;
            document.getElementById('v-s').innerText = p.scale; document.getElementById('v-r').innerText = p.rot; document.getElementById('v-a').innerText = p.alt;
            marker.setLatLng([p.lat, p.lon]); map.panTo([p.lat, p.lon]);
            document.getElementById('p-link').innerText = window.location.href.split('admin.html')[0] + 'index.html?id=' + id;
            sync();
        }

        function sync() { if(!activeId) return; const p=db[activeId]; const el=document.getElementById('ar-obj'); el.setAttribute('gltf-model','url('+p.model+')'); el.setAttribute('gps-entity-place','latitude:'+p.lat+'; longitude:'+p.lon+';'); el.setAttribute('scale',p.scale+' '+p.scale+' '+p.scale); el.setAttribute('rotation','0 '+p.rot+' 0'); el.setAttribute('position','0 '+p.alt+' 0'); }
        function move(dir) { const s = 0.000005; if(dir==='N') db[activeId].lat += s; if(dir==='S') db[activeId].lat -= s; if(dir==='E') db[activeId].lon += s; if(dir==='W') db[activeId].lon -= s; marker.setLatLng([db[activeId].lat, db[activeId].lon]); sync(); }
        function addNew() { const n = prompt("Proje AdÄ±:"); if(!n) return; const id = 'p' + Date.now(); db[id] = {id:id, name:n, model:'model.glb', lat:41.017, lon:28.858, scale:10, rot:0, alt:0}; save(); refreshList(); loadProj(id); }
        function setAtMe() { if(myPos.lat===0) return; db[activeId].lat=myPos.lat; db[activeId].lon=myPos.lon; marker.setLatLng([myPos.lat, myPos.lon]); map.panTo([myPos.lat, myPos.lon]); sync(); }
        ['p-scale','p-rot','p-alt'].forEach(id => { document.getElementById(id).oninput = (e) => { const v = parseFloat(e.target.value); db[activeId][id.replace('p-','')] = v; document.getElementById('v-'+id.charAt(2)).innerText = v; sync(); }; });
        function save() { localStorage.setItem('ar_db', JSON.stringify(db)); }
        function delProj() { if(confirm("Sil?")) { delete db[activeId]; save(); location.reload(); } }
        function copyLink() { navigator.clipboard.writeText(document.getElementById('p-link').innerText); alert("KopyalandÄ±!"); }

        refreshList();
        
        // SÄ°YAH EKRAN FÄ°X: SÃ¼rekli olarak video katmanÄ±nÄ± kontrol et
        setInterval(() => {
            const v = document.getElementById('arjs-video');
            if(v) {
                v.style.zIndex = "-2";
                v.style.position = "fixed";
                v.style.display = "block";
                document.body.style.backgroundColor = "transparent";
            }
        }, 500);
    </script>
</body>
</html>
